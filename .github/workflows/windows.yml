name: Windows Build
on:
  push:
    branches:
      - 'master'
      - 'windows-build'
    paths:
      - '**.[chly]'
      - '**/Makefile.am'
      - '.github/workflows/windows.yml'
  pull_request:
    paths:
      - '**.[chly]'
      - '**/Makefile.am'
      - '.github/workflows/windows.yml'
jobs:
  windows:
    runs-on: windows-latest
    env:
      APPVER: '10.0'
      CODESIGN_PKT: 0000000000000000
      INSTALL_DIR: C:\jq
      WINSDKVER: '10.0.22000.0'
      WIXDIR: 'c:\Program Files (x86)\Windows Installer XML v3.5'
    steps:
      - name: Clone repository
        uses: actions/checkout@v3
        with:
          submodules: true
      - uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            base-devel
            git
            clang
            autoconf
            automake
            libtool
            p7zip
      - shell: msys2 {0}
        run: |
          autoreconf -fiv
          ./configure --disable-valgrind --with-oniguruma=builtin --disable-shared --enable-static --enable-all-static
          make -j4
          make SUBDIRS="TESTS=tests/mantest tests/jqtest tests/onigtest tests/base64test" check
          7z a jq-windows.zip jq.exe
      - name: Upload Artifacts
        uses: actions/upload-artifact@v2
        with:
          name: jq artifacts
          path: |
            jq-windows.zip
      - name: Upload Test Logs
        if: ${{ failure() }}
        uses: actions/upload-artifact@v2
        with:
          name: Test logs
          path: test-suite.log
