#!/bin/sh

# This is meant to be included by each test's shell script driver.

if [ -n "$TRACE_TESTS" ]; then
    set -x
fi

set -eu

JQTESTDIR=$(cd "$(dirname "$0")" && pwd)
JQBASEDIR=$JQTESTDIR/..
JQ=${JQ:-$JQBASEDIR/jq}

# Some tests have locale-dependent output; use C locale.  Fixes #3038
LC_ALL=C
export LC_ALL

if [ -n "${ENABLE_VALGRIND-}" ] && which valgrind > /dev/null; then
    VALGRIND="valgrind --error-exitcode=1 --leak-check=full \
                       --suppressions=$JQTESTDIR/onig.supp \
                       --suppressions=$JQTESTDIR/local.supp"
    VG_EXIT0=--error-exitcode=0
    Q=-q
else
    VALGRIND=
    VG_EXIT0=
    Q=
fi

mods=$JQTESTDIR/modules

clean=true
d=
clean () {
    if ! $clean; then
        echo "See temp files in $d!"
    elif [ -n "$d" ]; then
        rm -rf "$d"
    fi
}
trap clean EXIT
d=$(mktemp -d -t jqXXXXXX || true)
if [ -z "$d" ]; then
    echo "Your OS does not support mktemp(1) -d" 1>&2
    exit 1
fi

jq_oniguruma_installed() {
    $JQ --exit-status --null-input '"" | test("")' > /dev/null 2>&1
}

if ! command -v awk > /dev/null; then
  echo "awk is required but not found in PATH."
  exit 1
fi

if [ ! -f "$JQTESTDIR/${TESTFILE:-jq.test}" ]; then
  echo "Test file '$JQTESTDIR/${TESTFILE:-jq.test}' not found."
  exit 1
fi
test_file() {
    status="$(jq_oniguruma_installed && echo enabled || echo disabled)"
    skip=0
    while IFS= read -r line; do
        if [ "$skip" -eq 1 ]; then skip=0; continue; fi
        case "$line" in
            "# jqtest oniguruma:"*)
                marker_status="${line#\# jqtest oniguruma:}"
                # Remove leading and trailing whitespace (POSIX shell way)
                marker_status="${marker_status#"${marker_status%%[![:space:]]*}"}"
                marker_status="${marker_status%"${marker_status##*[![:space:]]}"}"
                if [ "$marker_status" = "$status" ]; then
                    continue
                else
                    skip=1
                    continue
                fi
                ;;
        esac
        printf "%s\n" "$line"
    done < "$JQTESTDIR/${TESTFILE:-jq.test}"
}
