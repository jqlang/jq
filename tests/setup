#!/bin/sh

# This is meant to be included by each test's shell script driver.

if [ -n "$TRACE_TESTS" ]; then
    set -x
fi

set -eu

JQTESTDIR=$(cd "$(dirname "$0")" && pwd)
JQBASEDIR=$JQTESTDIR/..
JQ=${JQ:-$JQBASEDIR/jq}

# Some tests have locale-dependent output; use C locale.  Fixes #3038
LC_ALL=C
export LC_ALL

if [ -n "${ENABLE_VALGRIND-}" ] && which valgrind > /dev/null; then
    VALGRIND="valgrind --error-exitcode=1 --leak-check=full \
                       --suppressions=$JQTESTDIR/onig.supp \
                       --suppressions=$JQTESTDIR/local.supp"
    VG_EXIT0=--error-exitcode=0
    Q=-q
else
    VALGRIND=
    VG_EXIT0=
    Q=
fi

mods=$JQTESTDIR/modules

clean=true
d=
clean () {
    if ! $clean; then
        echo "See temp files in $d!"
    elif [ -n "$d" ]; then
        rm -rf "$d"
    fi
}
trap clean EXIT
d=$(mktemp -d -t jqXXXXXX || true)
if [ -z "$d" ]; then
    echo "Your OS does not support mktemp(1) -d" 1>&2
    exit 1
fi

oniguruma_status() {
    $JQ --exit-status --null-input '"" | test("")' > /dev/null 2>&1
}

if ! command -v awk > /dev/null; then
  echo "awk is required but not found in PATH."
  exit 1
fi

if [ ! -f "$JQTESTDIR/${TESTFILE:-jq.test}" ]; then
  echo "Test file '$JQTESTDIR/${TESTFILE:-jq.test}' not found."
  exit 1
fi
test_file() {
    awk -v status="$(oniguruma_status && echo enabled || echo disabled)" '
      /^# jqtest oniguruma:/ {
        if ($0 ~ status) next         # If matches current status, skip marker only
        skip=1; next                  # Else, skip this and the next line
      }
      skip { skip=0; next }           # Skip the line after the marker for the other status
      { print }
    ' "$JQTESTDIR/${TESTFILE:-jq.test}"
}
